<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Do have faith in what you are doing."><title>何处安放我们的 Go 代码 | Keep Coding</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-50745138-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '3ffc15f400ce3f8b1db5afc4f29b6ce9';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">何处安放我们的 Go 代码</h1><a id="logo" href="/.">Keep Coding</a><p class="description">Stay hungry, Stay foolish</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blogrolls/"><i class="fa fa-group"> 友情链接</i></a><a href="/podcast/"><i class="fa fa-podcast"> Podcast</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">何处安放我们的 Go 代码</h1><div class="post-meta">Oct 24, 2019<span> | </span><span class="category"><a href="/categories/langs/">编程语言</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 12</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" data-disqus-identifier="blog/2019/10/24/go-modules/" href="/blog/2019/10/24/go-modules/#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#GOPATH"><span class="toc-number">1.</span> <span class="toc-text">GOPATH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#百花齐放"><span class="toc-number">2.</span> <span class="toc-text">百花齐放</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Modules"><span class="toc-number">3.</span> <span class="toc-text">Modules</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Semantic-Version"><span class="toc-number">3.1.</span> <span class="toc-text">Semantic Version</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Replace"><span class="toc-number">3.2.</span> <span class="toc-text">Replace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用命令"><span class="toc-number">3.3.</span> <span class="toc-text">常用命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题排查"><span class="toc-number">4.</span> <span class="toc-text">问题排查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vgo"><span class="toc-number">5.</span> <span class="toc-text">vgo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>用了近半年的 Go，真是有种相见恨晚的感觉。简洁的语法、完善并强大的开发工具链，省去新手不少折腾的时间，可以专注写代码。<br>这期间也掌握了不少技巧与惯用法（idioms），比如 <a href="https://github.com/jiacai2050/prosumer" target="_blank" rel="noopener">prosumer</a>，就是一个踩了 chan/timer 一些坑后实现生产者/消费者模式框架。但今天不去谈 chan 的使用方式，而是来谈一个最基本的问题，Go 代码应该放在哪里，其实也就是 Go 的包管理机制，有时也称为版本化，其实是一个意思。这看似简单，却让不少 Gopher <a href="https://stackoverflow.com/questions/tagged/go-modules" target="_blank" rel="noopener">吃了不少苦头</a>。</p>
<p>本文大致顺序：包管理的历史；新的包管理方式 module；最后加上一个问题排查，彻底解决如何放置 Go 代码的问题。</p>
<p><img src="https://img.alicdn.com/imgextra/i4/581166664/O1CN01CCdfct1z69wzuInE9_!!581166664.png" alt="Go package manager"></p>
<h2 id="GOPATH"><a href="#GOPATH" class="headerlink" title="GOPATH"></a>GOPATH</h2><p>在 go mod 出现之前，所有的 Go 项目都需要放在同一个工作空间：<code>$GOPATH/src</code> 内，比如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">    github.com/golang/example/</span><br><span class="line">        .git/                      <span class="comment"># Git repository metadata</span></span><br><span class="line">    outyet/</span><br><span class="line">        main.go                <span class="comment"># command source</span></span><br><span class="line">        main_test.go           <span class="comment"># test source</span></span><br><span class="line">    stringutil/</span><br><span class="line">        reverse.go             <span class="comment"># package source</span></span><br><span class="line">        reverse_test.go        <span class="comment"># test source</span></span><br></pre></td></tr></table></figure></p>
<p>相比其他语言，这个限制有些无法理解。其实，这和 Go 的一设计理念紧密相关：</p>
<blockquote>
<p>包管理应该是去中心化的</p>
</blockquote>
<p>所以 Go 里面没有 maven/npm 之类的包管理工具，只有一个 <code>go get</code>，支持从公共的代码托管平台（Bitbucket/GitHub..）下载依赖，当然也支持自己托管，具体可参考官方文档：<a href="https://tip.golang.org/cmd/go/#hdr-Remote_import_paths" target="_blank" rel="noopener">Remote import paths</a>。</p>
<p>由于没有中央仓库，所以 Go 项目位置决定了其 import path，同时为了与 go get 保持一致，所以一般来说我们的项目名称都是 <code>github.com/user/repo</code> 的形式。<br>当然也可以不是这种形式，只是不方便别人引用而已，后面会讲到如何在 go mod 中实现这种效果。</p>
<h2 id="百花齐放"><a href="#百花齐放" class="headerlink" title="百花齐放"></a>百花齐放</h2><p>使用 <code>go get</code> 下载依赖的方式简单暴力，伴随了 Go 七年之久，直到 1.6（2016/02/17）才正式支持了 <a href="https://golang.org/doc/go1.6#go_command" target="_blank" rel="noopener">vendor</a>，可以把所有依赖下载到当前项目中，解决可重复构建（reproducible builds）的问题，但是无法管理依赖版本。社区出现了各式各样的<a href="https://github.com/golang/go/wiki/PackageManagementTools#dep-tool" target="_blank" rel="noopener">包管理工具</a>，来方便开发者固化依赖版本，由于不同管理工具采用不同的元信息格式（比如：godep 的 Godeps.json、Glide 的 glide.yaml），不利于社区发展，所以 Go 官方推出了 <a href="https://github.com/golang/dep" target="_blank" rel="noopener">dep</a>。</p>
<p>dep 的定位是实验、探索如何管理版本，并不会直接集成到 Go 工具链，Go 核心团队会吸取 dep 使用经验与社区反馈，开发下一代包管理工具 <a href="https://github.com/golang/go/wiki/Modules" target="_blank" rel="noopener">modules</a>，并于 2019/09/03 发布的 <a href="https://golang.org/doc/go1.13" target="_blank" rel="noopener">1.13</a> 正式支持，并随之发布 <a href="https://blog.golang.org/module-mirror-launch" target="_blank" rel="noopener">Module Mirror, Index, Checksum</a>，用于解决软件分发、中间人攻击等问题。下图截取自 Go <a href="https://blog.golang.org/modules2019" target="_blank" rel="noopener">官方博客</a></p>
<p><img src="https://img.alicdn.com/imgextra/i3/581166664/O1CN01NxbOES1z69wxSzgy2_!!581166664.png_620x10000.jpg" alt="Module Big Picture"></p>
<h2 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h2><p>Module 是多个 package 的集合，版本管理的基本单元，使用 go.mod 文件记录依赖的 module。</p>
<p>go.mod 位于项目的根目录，支持 4 条命令：module、require、replace、exclude。示例：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module github.com/my/repo</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">    github.com/some/dependency v1<span class="number">.2</span><span class="number">.3</span></span><br><span class="line">    github.com/another/dependency/v4 v4<span class="number">.0</span><span class="number">.0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>module 声明 module path，一个 module 内所有 package 的 import path 都以它为前缀</li>
</ul>
<p>假如一个 module 有如下目录结构，go.mod 采用上面的示例<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">repo</span><br><span class="line">|<span class="comment">-- bar</span></span><br><span class="line">|   `<span class="comment">-- bar.go</span></span><br><span class="line">|<span class="comment">-- foo</span></span><br><span class="line">|   `<span class="comment">-- foo.go</span></span><br><span class="line">`<span class="comment">-- go.mod</span></span><br></pre></td></tr></table></figure></p>
<p>那么 bar 包的 import path 即为：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/my/repo/bar"</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>require 声明所依赖的 module，版本信息使用形如 <code>v(major).(minor).(patch)</code> 的语义化版本 <a href="https://semver.org/" target="_blank" rel="noopener">semver</a>，比如：v0.1.0</li>
<li>replace/exclude 用于替换、排查指定 module path</li>
</ul>
<p>下面重点介绍 modules 中最实用的两个方面：semantic version 与 replace 指令。</p>
<h3 id="Semantic-Version"><a href="#Semantic-Version" class="headerlink" title="Semantic Version"></a>Semantic Version</h3><p><img src="https://img.alicdn.com/imgextra/i4/581166664/O1CN01bk1zqT1z69wz301hZ_!!581166664.png_620x10000.jpg" alt="语义化版本"></p>
<p>语义化版本要求 v1 及以上的版本保证向后兼容，v2 及以上的版本需要体现在 module path 中，比如</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module github.<span class="keyword">com</span>/my/<span class="keyword">mod</span>/v2</span><br><span class="line"></span><br><span class="line">require github.<span class="keyword">com</span>/my/<span class="keyword">mod</span>/v2 v2.<span class="number">0.1</span></span><br><span class="line">import <span class="string">"github.com/my/mod/v2/mypkg"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="built_in">get</span> github.<span class="keyword">com</span>/my/<span class="keyword">mod</span>/v2@v2.<span class="number">0.1</span></span><br></pre></td></tr></table></figure>
<p>之所以要求把版本号放在 module path，是为了解决不同大版本之间的 breaking changes。举一个场景：</p>
<p><img src="https://img.alicdn.com/imgextra/i3/581166664/O1CN01ZyOLHg1z69wz3Le3i_!!581166664.png_310x310.jpg" alt="dependency hell"></p>
<p>从上图可以看的，A 通过直接或间接依赖 D 的三个不同版本，如果不把版本号放在 module path 中，如何去加载正确的版本的？当然，这里有个前提，同一个大版本内必须保证向后兼容！</p>
<p>下面截取 prometheus 的部分 <a href="https://github.com/prometheus/prometheus/blob/master/go.mod" target="_blank" rel="noopener">go.mod</a>，来进一步探索 go.mod 的用法</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">module github.<span class="keyword">com</span>/prometheus/prometheus</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="number">1.13</span></span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">    # indirect 表示间接依赖</span><br><span class="line">    cloud.google.<span class="keyword">com</span>/<span class="keyword">go</span> v0.<span class="number">44.1</span> // indirect</span><br><span class="line">    k8s.io/klog v0.<span class="number">4.0</span></span><br><span class="line">    # 这里采用 pseudo_versions 表示没有采用 <span class="keyword">go</span> module，且没有打版本 <span class="keyword">tag</span></span><br><span class="line">    github.<span class="keyword">com</span>/alecthomas/units v0.<span class="number">0.0</span>-<span class="number">20190717042225</span>-c3de453c63f4</span><br><span class="line">    # incompatible 表示 <span class="keyword">go</span>-autorest 没有采用 <span class="keyword">go</span> module，而且版本大于 v2</span><br><span class="line">    github.<span class="keyword">com</span>/Azure/<span class="keyword">go</span>-autorest v11.<span class="number">2.8</span>+incompatible</span><br><span class="line">    github.<span class="keyword">com</span>/aws/aws-sdk-<span class="keyword">go</span> v1.<span class="number">23.12</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">replace (</span><br><span class="line">    # 表示从 github.<span class="keyword">com</span> 下载 klog，而不是 k8s.io</span><br><span class="line">    k8s.io/klog =&gt; github.<span class="keyword">com</span>/simonpasquier/klog-gokit v0.<span class="number">1.0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这里重点说一下伪版本 <a href="https://golang.org/cmd/go/#hdr-Pseudo_versions" target="_blank" rel="noopener">pseudo_versions</a>，主要用于兼容未采用 module 的依赖。一般形式：</p>
<ul>
<li><code>v0.0.0-yyyymmddhhmmss-abcdefabcdef</code></li>
</ul>
<p>中间的时间采用 UTC 表示，用于对比两个伪版本的新旧；最后的部分为 commit id 前 12 个字符。</p>
<h3 id="Replace"><a href="#Replace" class="headerlink" title="Replace"></a>Replace</h3><p>go.mod 的 replace 主要用于替换 module path，这对于引用本地依赖非常有帮助。比如有一个库 <code>github.com/user/lib</code> 有 bug，你需要 fork 到本地去修复，这时在自己的项目中需要引用本地 fork 的分支，那么就可以这么用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">replace</span> github.com/<span class="keyword">user</span>/lib =&gt; /<span class="keyword">some</span>/<span class="keyword">path</span>/<span class="keyword">on</span>/your/disk</span><br></pre></td></tr></table></figure>
<p>代码里面的 import path 不用变。</p>
<p>类似的原理，项目的 module 名字，也不必加上托管平台前缀了。我创建了一个示例项目 <a href="https://github.com/jiacai2050/strutil" target="_blank" rel="noopener">strutil</a>，其 go.mod 如下：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">strutil</span></span></span><br><span class="line"></span><br><span class="line">go <span class="number">1.12</span></span><br></pre></td></tr></table></figure>
<p>如果要引用这个项目，只需要这么做：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// go.mod</span></span><br><span class="line">replace strutil =&gt; github.com/jiacai2050/strutil v0<span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// str_test.go</span></span><br><span class="line"><span class="keyword">import</span> strutil</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestModule</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    s := strutil.Reverse(<span class="string">"hello"</span>)</span><br><span class="line">    assert.Equal(t, <span class="string">"olleh"</span>, s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>对于使用 module 开发的项目，使用 <code>go mod init {moduleName}</code> 初始化后，直接在源文件中 import 所需包名，go test/build 之类的命令会自动分析，将其加到 go.mod 中的 require 里面，不需要自己去修改。开发测试完成后，需要打 tag 才能让其它用户使用。<br>项目的版本号一般从 v0.1.0 开始，表示开始第一个 feature，当有 bugfix 时，变更第三个版本号，如 v0.1.1；当有新 feature 时，变更中间版本号，如 v0.2.0；有 breaking changes 时，变更第一个版本号，比如 v1.0.0。</p>
<p>除此之外，一般还需配置如下相关变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.13 默认开启</span></span><br><span class="line"><span class="built_in">export</span> GO111MODULE=on</span><br><span class="line"><span class="comment"># 1.13 之后才支持多个地址，之前版本只支持一个</span></span><br><span class="line"><span class="built_in">export</span> GOPROXY=https://goproxy.cn,https://mirrors.aliyun.com/goproxy,direct</span><br><span class="line"><span class="comment"># 1.13 开始支持，配置私有 module，不去校验 checksum</span></span><br><span class="line"><span class="built_in">export</span> GOPRIVATE=*.corp.example.com,rsc.io/private</span><br></pre></td></tr></table></figure>
<p>关于 module 校验的更多内容，可参考：</p>
<ul>
<li><a href="https://golang.org/cmd/go/#hdr-Module_configuration_for_non_public_modules" target="_blank" rel="noopener">https://golang.org/cmd/go/#hdr-Module_configuration_for_non_public_modules</a></li>
</ul>
<p>其它常用命令有：</p>
<ul>
<li><p><code>go mod download -json</code> 查看 module 详细信息</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type Module struct &#123;</span><br><span class="line">    Path    <span class="built_in"> string</span> // <span class="keyword">module</span><span class="built_in"> path</span></span><br><span class="line">    Version <span class="built_in"> string</span> // <span class="keyword">module</span> version</span><br><span class="line">    Error   <span class="built_in"> string</span> //<span class="built_in"> error</span> loading <span class="keyword">module</span></span><br><span class="line">    Info    <span class="built_in"> string</span> // absolute<span class="built_in"> path</span> <span class="keyword">to</span> cached .info file</span><br><span class="line">    GoMod   <span class="built_in"> string</span> // absolute<span class="built_in"> path</span> <span class="keyword">to</span> cached .mod file</span><br><span class="line">    Zip     <span class="built_in"> string</span> // absolute<span class="built_in"> path</span> <span class="keyword">to</span> cached .zip file</span><br><span class="line">    Dir     <span class="built_in"> string</span> // absolute<span class="built_in"> path</span> <span class="keyword">to</span> cached source<span class="built_in"> root</span> directory</span><br><span class="line">    Sum     <span class="built_in"> string</span> // checksum <span class="keyword">for</span><span class="built_in"> path</span>, version (<span class="keyword">as</span> <span class="keyword">in</span> go<span class="built_in">.sum</span>)</span><br><span class="line">    GoModSum<span class="built_in"> string</span> // checksum <span class="keyword">for</span> go.mod (<span class="keyword">as</span> <span class="keyword">in</span> go<span class="built_in">.sum</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>go list -m all</code> 查看当前项目最终所使用的 module 版本</p>
</li>
<li><code>go list -u -m all</code> 查看依赖的新版本</li>
<li><code>go get -u ./...</code> 更新所有依赖到最新版</li>
<li><code>go get -u=patch ./...</code> 更新所有依赖到最新的 patch 版本</li>
<li><code>go mod tidy</code> 清理 go.mod/go.sum 中不在需要的 module</li>
<li><code>go mod vendor</code> 创建 vendor 依赖目录，这时为了与之前做兼容，后面在执行 go test/build 之类的命令时，可以加上 <code>-mod=vendor</code> 这个 build flag 声明使用 vendor 里面的依赖，这样 go mod 就不会再去 <code>$GOPATH/pkg/mod</code> 里面去找。</li>
</ul>
<h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><p>在使用 go mod 中我遇到过一个问题，之前很是困扰，后来才发现是没清楚 go 命令参数的含义。下面首先看下项目目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/code/ceresdb-go-sdk</span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">├── Makefile</span><br><span class="line">├── ceresdb</span><br><span class="line">│   ├── client.go</span><br><span class="line">│   ├── client_test.go</span><br><span class="line">├── examples</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   └── quickstart.go</span><br><span class="line">├── go.mod</span><br><span class="line">└── go.sum</span><br><span class="line"></span><br><span class="line">$ cat go.mod</span><br><span class="line">module github.com/user/ceresdb-go-sdk</span><br><span class="line">require ( ... )</span><br></pre></td></tr></table></figure>
<p>可以看到，项目根目录 ceresdb-go-sdk 内没有 go 源码，而是放在了 ceresdb 子目录中，这么设计的目的是保证 import path 与目录名一致</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/user/ceresdb-go-sdk/ceresdb"</span></span><br><span class="line">c := ceresdb.NewClient(...)</span><br></pre></td></tr></table></figure>
<p>当然也可以去掉 ceresdb 目录，将源码放在项目根目录下，这样 import 就变为<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/user/ceresdb-go-sdk"</span></span><br><span class="line">c := ceresdb.NewClient(...)</span><br></pre></td></tr></table></figure></p>
<p>感觉不是很友好，有些 IDE 比较智能，会自动填充 alias<br><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这也说明包名可以不和目录一致！但是一般都要保证一致，否则会很具备迷惑性</span></span><br><span class="line"><span class="keyword">import</span> ceresdb <span class="string">"github.com/user/ceresdb-go-sdk"</span></span><br></pre></td></tr></table></figure></p>
<p>但现在还是假设采用子目录的方式，执行 <code>go test ./...</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">time go test -v -x  ./...</span><br><span class="line">can't <span class="keyword">load</span> <span class="keyword">package</span>: <span class="keyword">package</span> github.com/<span class="keyword">user</span>/ceresdb-<span class="keyword">go</span>-sdk: <span class="literal">unknown</span> <span class="keyword">import</span> <span class="keyword">path</span> <span class="string">"github.com/user/ceresdb-go-sdk"</span>: cannot find <span class="keyword">module</span> providing <span class="keyword">package</span> github.com/<span class="keyword">user</span>/ceresdb-<span class="keyword">go</span>-sdk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意花的时间，这期间没有任何输出，即使加了 -x flag</span></span><br><span class="line"><span class="built_in">real</span>	<span class="number">1</span>m2<span class="number">.472</span>s</span><br><span class="line"><span class="keyword">user</span>	<span class="number">0</span>m0<span class="number">.111</span>s</span><br><span class="line"><span class="keyword">sys</span>	<span class="number">0</span>m0<span class="number">.082</span>s</span><br></pre></td></tr></table></figure>
<p>对于这个错误有些懵，我这个项目不就是  github.com/user/ceresdb-go-sdk 嘛，怎么会报找不到呢？为了解释原因，需要了解下 go 命令的一般形式：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">go</span> <span class="selector-tag">command</span> <span class="selector-attr">[command_args]</span> <span class="selector-attr">[build flags]</span> <span class="selector-attr">[packages]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>command 是指 test/build/mod/list 之类命令</li>
<li>command_args 是指特定命令相关的参数</li>
<li>build flags 是大部分命令都支持的参数，比较常用的有：<ul>
<li><code>-race</code> 开启 race 检测</li>
<li><code>-v</code> 输出正在编译的包名</li>
<li><code>-x</code> 输出详细执行的命令，在 go get 卡住时可以打开定位问题</li>
<li><code>-mod</code> 指定 module 依赖下载模式，目前只有两个值：readonly 或者 vendor</li>
<li><code>-tags</code> 逗号分隔编译 tags，主要用于区别 build 环境，比如<a href="https://stackoverflow.com/a/28007631/2163429" target="_blank" rel="noopener">集成测试</a></li>
</ul>
</li>
<li>packages 指定当前命令作用的包</li>
</ul>
<p>上面的错误就出错在最后一个参数上，我们知道包的 import path 需要加上 module path，上面的错误也证明了这一点。<br>特殊的，对于 <code>./xxx</code> 会去找对应目录下面的包，不用写 module path 了，<code>./...</code> 则意味着递归地找当前目录下的所有包，且包括当前目录。<br>问题就在于项目根目录下没有任何 go 源文件，所以就找不到当前目录下的包了！解决方法也很简单：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> test  ./ceresdb</span><br><span class="line"># <span class="keyword">go</span> test github.<span class="keyword">com</span>/user/ceresdb-<span class="keyword">go</span>-sdk/ceresdb 当然也可以</span><br><span class="line">...</span><br><span class="line">PASS</span><br><span class="line">ok  	github.<span class="keyword">com</span>/user/ceresdb-<span class="keyword">go</span>-sdk/ceresdb	<span class="number">0.017</span>s</span><br></pre></td></tr></table></figure>
<p>或者，在根目录下加一个 go 文件</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 包名可以和 import path 不一致，所以这里 <span class="keyword">abc</span> 也是可以的</span><br><span class="line">$ <span class="keyword">echo</span> <span class="string">'package abc'</span> &gt; <span class="keyword">abc</span>.<span class="keyword">go</span></span><br><span class="line">$ <span class="keyword">go</span> test .</span><br><span class="line">?   	github.<span class="keyword">com</span>/user/ceresdb-<span class="keyword">go</span>-sdk	[<span class="keyword">no</span> test <span class="keyword">files</span>]</span><br></pre></td></tr></table></figure>
<p>这样也不会报错了。</p>
<h2 id="vgo"><a href="#vgo" class="headerlink" title="vgo"></a>vgo</h2><p><a href="https://github.com/golang/vgo" target="_blank" rel="noopener">vgo</a> 是 Go 的核心开发者 <a href="https://swtch.com/~rsc/" target="_blank" rel="noopener">Russ Cox</a> 尝试给 Go 增加包管理的原型，是个单独的命令，相当于自动加上 <code>GO111MODULE=on</code> 的 go 命令，在把包管理功能集成到 go 命令时，才叫 modules。</p>
<blockquote>
<p>The reference implementation was named vgo, but support for modules is being integrated into the go command itself. The feature within the go command is called “versioned Go modules” (or “modules” for short), not “vgo”.</p>
</blockquote>
<p>关于 Go 的包管理，Russ Cox 有一系列 <a href="https://github.com/golang/go/wiki/vgo" target="_blank" rel="noopener">vgo</a> 的文章介绍<a href="https://research.swtch.com/vgo" target="_blank" rel="noopener">来龙去脉</a>，感兴趣的读者可以去看看。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过本文的介绍，希望让大家更清楚了解 modules 的设计初衷以及如何排查问题，做到语义化版本，大版本向后兼容。如果你的项目比较复杂，项目的结构可以参考：</p>
<ul>
<li><a href="https://github.com/golang-standards/project-layout" target="_blank" rel="noopener">https://github.com/golang-standards/project-layout</a></li>
</ul>
<p>Clojure 作者 Rich Hickey 有个有名的演讲 <a href="https://github.com/matthiasn/talk-transcripts/blob/master/Hickey_Rich/SimpleMadeEasy.md" target="_blank" rel="noopener">Simple Made Easy</a>，主要讲述了可以通过简单的工具来降低软件开发的复杂度，Go 作者 Rob Pike 在 2015 年的一个 talk <a href="https://talks.golang.org/2015/simplicity-is-complicated.slide#1" target="_blank" rel="noopener">Simplicity is Complicated</a> 中也指出，Go 成功的一大原因源自其简单易用的特性。</p>
<p><img src="https://img.alicdn.com/imgextra/i1/581166664/O1CN012w8eQ11z69x0Nk2xz_!!581166664.jpg" alt="Simplicity"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://golang.org/doc/code.html" target="_blank" rel="noopener">https://golang.org/doc/code.html</a></li>
<li><a href="https://blog.golang.org/modules2019" target="_blank" rel="noopener">https://blog.golang.org/modules2019</a></li>
<li><a href="https://research.swtch.com/vgo-intro" target="_blank" rel="noopener">https://research.swtch.com/vgo-intro</a></li>
<li><a href="https://medium.com/@sdboyer/so-you-want-to-write-a-package-manager-4ae9c17d9527" target="_blank" rel="noopener">https://medium.com/@sdboyer/so-you-want-to-write-a-package-manager-4ae9c17d9527</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://liujiacai.net/blog/2019/10/24/go-modules/" data-id="ck64yiach005kn5lj3b1miqfl" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACH0lEQVR42u3aS26EMBAFwNz/0mSbDeS9NjMSpliNNGBcLFruz89PfB1/rrN/8/vP7kmeWrowMDAeyzgur+sX5C9OPsT1e8/uwcDAeA/jOoxeA87unPGSFTAwMDBmyyXBNHkWAwMDY52RpKZ5mpr/i4GBgZEkscnvGfKruTgGBsYDGXnV/fu/P9LfwMDAeBTjKK+29Ti7s94VBgbG1oxPlO/zJuW97QQMDIxdGSuhcJaUtmlwsgIGBsbejJUkc3YQbMfLij1gYGBsysi3cj0Klo+OFS3JfIADAwPjNYx8W+3Bsf0QCRgDA+M9jGRIYrhouc5sjGy4UQwMjEcxhu6FmYd2mCxKazEwMF7AaI9os9LYXZNdp0ksBgbGpoy2fD87zBWhsy20zbaCgYHxKEbbbsxDc/sh6tGKNonFwMB4LKMtq7Xl/pUmwWzgAwMDYz/GrOi/0irIQ2feSMDAwNib0aaU3zw+DpumGBgYmzKSQlh7jMtJ64dODAwMjE+MYrSwaA8YGBivYayE2nyLK0W9opGJgYGxHSN5TV64bwe/ZoEbAwPjDYyjvPLEtQ3Tw8Q1+UIYGBgPZ9yVgq4U79oBi7zBiYGBsRMjCbL5VtpWZRuIi8cwMDC2Y6wHvpa6gsTAwMBoS2nJOneNhd0WcDEwMF7PqBuQZQr9TycWAwNjU0Y7WtoC2nDcvgUDA2Nvxl1DFbOt5ye9G5qaGBgYz2P8Ahli2xlRLe22AAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/Go/">Go</a></div><div class="post-nav"><a class="pre" href="/blog/2020/02/02/review-2019/">2019 年终总结</a><a class="next" href="/blog/2019/07/17/hello-golang/">写给新手的 Go 开发指南</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://liujiacai.net/blog/2019/10/24/go-modules/';
    this.page.identifier = 'blog/2019/10/24/go-modules/';
    this.page.title = '何处安放我们的 Go 代码';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//jiacai2050.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//jiacai2050.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://jiacai2050.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://liujiacai.net"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/reproduce/">他山之石</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">大数据</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/search-engine/">搜索引擎</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">热爱生活</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/aha-computer/">理解计算机</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/研习经典/">研习经典</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/langs/">编程语言</a><span class="category-list-count">24</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/lucene/" style="font-size: 15px;">lucene</a> <a href="/tags/java/" style="font-size: 15px;">Java</a> <a href="/tags/music/" style="font-size: 15px;">music</a> <a href="/tags/GEB/" style="font-size: 15px;">GEB</a> <a href="/tags/mooc/" style="font-size: 15px;">mooc</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/algorithm/" style="font-size: 15px;">算法</a> <a href="/tags/mozilla/" style="font-size: 15px;">mozilla</a> <a href="/tags/lambda/" style="font-size: 15px;">Lambda</a> <a href="/tags/lisp/" style="font-size: 15px;">Lisp</a> <a href="/tags/best-practice/" style="font-size: 15px;">最佳实践</a> <a href="/tags/linux/" style="font-size: 15px;">Linux</a> <a href="/tags/javascript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/sicp/" style="font-size: 15px;">sicp</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/scheme/" style="font-size: 15px;">Scheme</a> <a href="/tags/string/" style="font-size: 15px;">string</a> <a href="/tags/python/" style="font-size: 15px;">Python</a> <a href="/tags/ruby/" style="font-size: 15px;">Ruby</a> <a href="/tags/Clojure/" style="font-size: 15px;">Clojure</a> <a href="/tags/ideas/" style="font-size: 15px;">ideas</a> <a href="/tags/gc/" style="font-size: 15px;">GC</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2020/02/02/review-2019/">2019 年终总结</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/10/24/go-modules/">何处安放我们的 Go 代码</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/07/17/hello-golang/">写给新手的 Go 开发指南</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/04/21/experience-in-clojure/">Clojure 开发经验总结</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/01/09/java-gc-definitive-guide/">Java 垃圾回收权威指北</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/12/29/how-java-synchronizer-work/">Java 线程同步原理探析</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/11/10/damn-single-socket/">形单影只的 Socket</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/18/generational-gc/">深入浅出垃圾回收（四）分代式 GC</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/04/incremental-gc/">深入浅出垃圾回收（三）增量式 GC</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/07/08/mark-sweep/">深入浅出垃圾回收（二）Mark-Sweep 详析及其优化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//jiacai2050.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Keep Coding.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>