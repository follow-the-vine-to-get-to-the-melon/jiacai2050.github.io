<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Clojure 开发经验总结 - Keep Coding</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="刘家财" /><meta name="description" content="大概在两年半前，我开始陆陆续续写了一系列文章，来介绍如何上手、深入 Clojure，后来有幸加入 LeanCloud 写了两年的 Clojure，期间制作了一套七集" /><meta name="keywords" content="lisp, clojure, emacs, database, life" />






<meta name="generator" content="Hugo 0.79.0 with theme even" />


<link rel="canonical" href="https://liujiacai.net/blog/2019/04/21/experience-in-clojure/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c7bc1becf36bcf6a9ebd25d2947e43a2eb745ddb0c9a32b43126fd7fa460c351.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/jiacai.css">


<meta property="og:title" content="Clojure 开发经验总结" />
<meta property="og:description" content="大概在两年半前，我开始陆陆续续写了一系列文章，来介绍如何上手、深入 Clojure，后来有幸加入 LeanCloud 写了两年的 Clojure，期间制作了一套七集" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liujiacai.net/blog/2019/04/21/experience-in-clojure/" />
<meta property="article:published_time" content="2019-04-21T13:10:52+00:00" />
<meta property="article:modified_time" content="2020-12-09T22:15:51+08:00" />
<meta itemprop="name" content="Clojure 开发经验总结">
<meta itemprop="description" content="大概在两年半前，我开始陆陆续续写了一系列文章，来介绍如何上手、深入 Clojure，后来有幸加入 LeanCloud 写了两年的 Clojure，期间制作了一套七集">
<meta itemprop="datePublished" content="2019-04-21T13:10:52+00:00" />
<meta itemprop="dateModified" content="2020-12-09T22:15:51+08:00" />
<meta itemprop="wordCount" content="3646">



<meta itemprop="keywords" content="Clojure," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Clojure 开发经验总结"/>
<meta name="twitter:description" content="大概在两年半前，我开始陆陆续续写了一系列文章，来介绍如何上手、深入 Clojure，后来有幸加入 LeanCloud 写了两年的 Clojure，期间制作了一套七集"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Keep Coding</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/podcast/">
        <li class="mobile-menu-item">Podcast</li>
      </a><a href="/blogrolls/">
        <li class="mobile-menu-item">友链</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Keep Coding</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/podcast/">Podcast</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/blogrolls/">友链</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Clojure 开发经验总结</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-04-21 </span>
        <div class="post-category">
            <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/"> 编程语言 </a>
            </div>
          <span class="more-meta"> 约 3646 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ide">IDE</a>
          <ul>
            <li><a href="#emacs">Emacs</a></li>
            <li><a href="#cider--lein">Cider + Lein</a></li>
          </ul>
        </li>
        <li><a href="#clojure-踩雷区">Clojure 踩雷区</a>
          <ul>
            <li><a href="#lazy">Lazy</a></li>
            <li><a href="#动态变量">动态变量</a></li>
            <li><a href="#nil">nil</a></li>
            <li><a href="#future">future</a></li>
          </ul>
        </li>
        <li><a href="#长期维护-clojure-项目">长期维护 Clojure 项目</a>
          <ul>
            <li><a href="#test">Test</a></li>
            <li><a href="#lint">Lint</a></li>
            <li><a href="#跟进社区">跟进社区</a></li>
          </ul>
        </li>
        <li><a href="#他山之石">他山之石</a>
          <ul>
            <li><a href="#nathan-marzhttpnathanmarzcom"><a href="http://nathanmarz.com/">Nathan Marz</a></a></li>
            <li><a href="#kyle-kingsburyhttpsaphyrcom-aka-aphyr"><a href="https://aphyr.com">Kyle Kingsbury</a> a.k.a &ldquo;Aphyr&rdquo;</a></li>
            <li><a href="#zach-tellmanhttpsideolaliacom"><a href="https://ideolalia.com/">Zach Tellman</a></a></li>
          </ul>
        </li>
        <li><a href="#clojure-工作机会">Clojure 工作机会</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>大概在两年半前，我开始陆陆续续写了<a href="/tags/Clojure/">一系列文章</a>，来介绍如何上手、深入 Clojure，后来有幸加入 LeanCloud 写了两年的 Clojure，期间制作了一套<a href="https://github.com/jiacai2050/learn_clojure.mp4">七集的教学视频</a>，算是对这门语言有了较为全面的认识。
鉴于国内 Clojure 普及程度很低，我觉得有必要把这些年的经验整理出来，可能会有些片面，但贵在真实，希望我的这些实战经验能帮助到后面 Clojure 的学习者。</p>
<p>工欲善其事，必先利其器。首先，会介绍如何打造高效实用的集成开发环境（IDE）；接着会介绍 Clojure 语言特性隐藏的一些坑；之后就如何长期维护 Clojure 项目提供一些思路；然后会介绍 Clojure 社区中一些重量级的人物，通过阅读他们的代码可以极大增强自己的内功；最后想谈下对国内 Clojure 找工作的个人见解。</p>
<h2 id="ide">IDE</h2>
<p>在 <a href="/blog/2016/12/31/dev-in-clojure">Clojure 开发那些事</a> 中，介绍了开发 Clojure 的两种组合，即 IDEA+Cursive 与 Emacs+Cider。我一直用的是 Emacs 这一组合，在编写与 Java 交互比较多的情况下，会去采用 IDEA 方案。</p>
<p>关于编辑器之争，这里没必要讨论，适合自己的才是最好的，都是工具而已，写出优雅的代码才是目的。这里仅仅分享个人使用 Emacs 的一些小心得。</p>
<h3 id="emacs">Emacs</h3>
<p>Emacs 是起源最早的编辑器之一。有人说它是伪装成编辑器的操作系统，我当初怀揣着试试看的心理，反反复复用了几次，但基本上都无疾而终，相比于 VSCode 之类开箱即用的编辑器， Emacs 确实很不友好。后来才知道，入门 Emacs，最好的方式是先用前辈们的配置文件，然后逐渐去适应、学习。
这个过程比较痛苦，我大概持续了一周左右，即使到了今天，也还是有可能陶醉在配置文件的修改中，一改就是3、4个小时，因为它的配置文件就是 Elisp 代码，随着使用程度的增加，这些代码会变得比较复杂，所以隔一段时间，我就会重新整理一下，寻找最佳的管理方式。</p>
<ul>
<li><a href="https://github.com/flyingmachine/emacs-for-clojure">https://github.com/flyingmachine/emacs-for-clojure</a> 这是我最初参考的配置</li>
<li><a href="https://github.com/jiacai2050/dotfiles/tree/master/.emacs.d">https://github.com/jiacai2050/dotfiles/tree/master/.emacs.d</a> 这是我目前的配置</li>
</ul>
<p>建议感兴趣的同学专门拿出两天来学习 Emacs 一些基本操作，然后强迫自己在日常工作中使用它，这样应该能很快上手，一旦习惯了，基本上就离不开了，我目前除了 Java 用 IDEA 开发外，其余的 go/python/js/rust 等都用 Emacs 搞定。喜欢折腾的同学不要错过！
下面介绍两个 Emacs 中杀手锏：</p>
<ul>
<li><a href="https://magit.vc/">Magit, A Git Porcelain inside Emacs</a> 深度与 Emacs 整合的 git 客户端，非常好用</li>
<li><a href="https://orgmode.org/">Org mode</a> 一个强大的标记语言，完虐 markdown</li>
</ul>
<p>最后，国内的 Emacs 社区也是非常推荐，经常会有精彩的讨论，各种使用问题都可以在上面找到答案</p>
<ul>
<li><a href="https://emacs-china.org/">https://emacs-china.org/</a></li>
</ul>
<h3 id="cider--lein">Cider + Lein</h3>
<p>Cider 全称是 The Clojure Interactive Development Environment that Rocks for Emacs</p>
<p>参考 flyingmachine 的配置，能把 cider+lein 跑起来，在使用过程中，我逐渐总结出一套“最佳实践”，供大家参考：</p>
<ol>
<li>慎重升级。每次升级 cider，我都会<a href="https://github.com/clojure-emacs/cider/issues?utf8=%E2%9C%93&amp;q=is%3Aissue+commenter%3Ajiacai2050+">或多或少遇到些问题</a>，这很烦人，尤其是你要开始干活的时候，IDE 突然坏了，于是乎你不得不停下手中的活，来修复它。虽然社区反应还算快，但还是挺影响效率的。</li>
<li><a href="https://github.com/technomancy/leiningen">lein</a> 作为 Clojure 默认的项目管理工具，已够用，不需要再去折腾 <a href="https://github.com/boot-clj/boot">boot-clj</a>
<ul>
<li><a href="https://github.com/technomancy/leiningen/blob/master/doc/TUTORIAL.md#checkout-dependencies">Checkout Dependencies</a> 多项目开发时必备的技巧，可以快速定位依赖的源码。项目目录大概是这样子的：</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">.
|-- project.clj
|-- README.md
|-- checkouts
|   `-- suchwow [link to ~/code/oss/suchwow]
|   `-- commons [link to ~/code/company/commons]
|-- src
|   `-- my_stuff
|       `-- core.clj
`-- test
  `-- my_stuff
      `-- core_test.clj

</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>Clojure REPL 启动很慢，所以正确的姿势是启动一个 REPL 后，不去关闭它，一直在里面去调试代码，有下面几个 plugin 使用的推荐：
<ul>
<li><a href="https://github.com/palletops/lein-shorthand">lein-shorthand</a> + <a href="https://github.com/pallet/alembic">alembic</a> 可以在已启动的 REPL 中动态添加新依赖，不需要重启，必备！</li>
<li><a href="https://github.com/vvvvalvalval/scope-capture">scope-capture</a> 让 REPL 开发、测试流程如丝般柔滑！</li>
<li><a href="https://github.com/jiacai2050/dotfiles/blob/master/.lein/profiles.clj">profiles.clj</a> 是我目前的配置，供参考</li>
<li>REPL 启动久了，难免变得比较“脏”，对于改动较多的情况，在正式 push 到 remote 前，建议重启 REPL 测试</li>
</ul>
</li>
</ol>
<h2 id="clojure-踩雷区">Clojure 踩雷区</h2>
<p>每门语言都会过度宣扬自己的长处，而刻意回避自己不擅长的地方，这无可厚非。这一小节就会介绍下 Clojure 中容易出问题的几个地方：</p>
<h3 id="lazy">Lazy</h3>
<p><a href="https://clojure.org/reference/lazy">惰性</a>是 Clojure 语言的一重要特性，按需求值，看起来很美好，但是用起来坑缺很多。
首先就是官方文档里介绍的 <a href="https://clojure.org/reference/lazy#_dont_hang_onto_your_head">Don’t hang (onto) your head</a>，类似的变种还有 <a href="https://stuartsierra.com/2015/04/26/clojure-donts-concat">lazy-seq + concat</a> 的组合，非常容易写出看似优雅、实则暗藏 bug 的代码，到现在我都必须非常小心的使用它们，并且不能完全保证没有错误。</p>
<p>另一个是与动态变量结合时，比如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="k">def </span><span class="nv">*some-predict*</span> <span class="nv">true</span><span class="p">)</span>

<span class="p">(</span><span class="k">def </span><span class="nv">do-somework</span> <span class="p">[</span><span class="nv">exercises</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*some-predict*</span> <span class="nv">false</span><span class="p">]</span>
    <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="p">(</span><span class="nf">do-with</span> <span class="nv">x</span><span class="p">))</span>
         <span class="nv">exercises</span><span class="p">)))</span>
</code></pre></td></tr></table>
</div>
</div><p>由于 map 是惰性求值的，导致 do-somework 在返回后还没有真正求值（realize），导致没有用到函数内 binding 的值。</p>
<h3 id="动态变量">动态变量</h3>
<p>动态变量解决的问题就是在不改变函数签名（主要是参数）的情况下，改变函数的行为。但用好它并不容易，除了上面提及的与 lazy 整合的问题，还要注意，其 binding 的值是不能跨线程的，为了解决这个问题，Clojure 1.3 版本提出了 <a href="https://github.com/clojure/clojure/blob/master/changes.md#234-binding-conveyance">binding conveyance</a>，但仅仅对 Clojure 自身的线程池有效，然后又增加了 <a href="https://clojuredocs.org/clojure.core/bound-fn">bound-fn</a> 来解决这个问题。可以参考下面的例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*num*</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*num*</span> <span class="mi">2</span><span class="p">]</span>
  <span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nb">println </span><span class="nv">*num*</span><span class="p">)))</span>
<span class="c1">;; 因为 binding conveyance，这里打印 &#34;2&#34;</span>

<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="o">^</span><span class="nv">ExecutorService</span> <span class="nv">executor</span> <span class="p">(</span><span class="nf">Executors/newFixedThreadPool</span> <span class="mi">1</span><span class="p">)]</span>
  <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*num*</span> <span class="mi">2</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">.submit</span> <span class="nv">executor</span> <span class="o">^</span><span class="nv">Callable</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">*num*</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">.shutdown</span> <span class="nv">executor</span><span class="p">)))</span>
<span class="c1">;; 对于自定义线程池，这里打印 &#34;1&#34;</span>

<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="o">^</span><span class="nv">ExecutorService</span> <span class="nv">executor</span> <span class="p">(</span><span class="nf">Executors/newFixedThreadPool</span> <span class="mi">1</span><span class="p">)]</span>
  <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*num*</span> <span class="mi">2</span><span class="p">]</span>
    <span class="p">(</span><span class="nf">.submit</span> <span class="nv">executor</span> <span class="o">^</span><span class="nv">Callable</span> <span class="p">(</span><span class="nf">bound-fn</span> <span class="p">[]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">*num*</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">.shutdown</span> <span class="nv">executor</span><span class="p">)))</span>
<span class="c1">;; 对于 bound-fn ，这里打印 &#34;2&#34;</span>

</code></pre></td></tr></table>
</div>
</div><p>更多可参考：</p>
<ul>
<li><a href="https://stuartsierra.com/2013/03/29/perils-of-dynamic-scope">https://stuartsierra.com/2013/03/29/perils-of-dynamic-scope</a></li>
</ul>
<h3 id="nil">nil</h3>
<p>nil 表示无，在不同场景下有不同含义，而且 Clojure 想尽量屏蔽掉这种差异性，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-clojure" data-lang="clojure"><span class="nv">user&gt;</span> <span class="p">(</span><span class="nb">str </span><span class="nv">nil</span> <span class="s">&#34;abc&#34;</span><span class="p">)</span>
<span class="s">&#34;abc&#34;</span>
<span class="nv">user&gt;</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">nil</span> <span class="s">&#34;abc&#34;</span><span class="p">)</span>
<span class="p">(</span><span class="s">&#34;abc&#34;</span><span class="p">)</span>
<span class="nv">user&gt;</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">nil</span> <span class="ss">:a</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:a</span> <span class="mi">1</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>但时不时 nil 就会出来咬你一口。记得之前有这么一个需求，需要对消息的格式做了升级，之前可能是 map/string，升级后只能是 string 并且用 v2 标示，处理的代码需要找出这两类消息，分别处理，代码大致如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="k">let </span><span class="p">[{</span><span class="nv">v1-msgs</span> <span class="nv">false</span> <span class="nv">v2-msgs</span> <span class="nv">true</span><span class="p">}</span>
      <span class="p">(</span><span class="nf">group-by</span> <span class="o">#</span><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">string? </span><span class="nv">%</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">.startsWith</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">%</span> <span class="s">&#34;v2:&#34;</span><span class="p">))</span> <span class="nv">msgs</span><span class="p">)])</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，代码很简单，就是判断 msg 是不是字符串，如果是，再看看版本是不是 v2，由于 nil 与 false 是不同的值，导致会丢失一部分数据，正确的写法是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-clojure" data-lang="clojure"><span class="p">(</span><span class="k">let </span><span class="p">[{</span><span class="nv">v1-msgs</span> <span class="nv">false</span> <span class="nv">v2-msgs</span> <span class="nv">true</span><span class="p">}</span>
      <span class="p">(</span><span class="nf">group-by</span> <span class="o">#</span><span class="p">(</span><span class="nb">boolean </span><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">string? </span><span class="nv">%</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">.startsWith</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">%</span> <span class="s">&#34;v2:&#34;</span><span class="p">)))</span> <span class="nv">msgs</span><span class="p">)])</span>
</code></pre></td></tr></table>
</div>
</div><p>所以这里的一个提醒就是尽量不要让自己的函数返回 nil，而是返回空值，比如空数组、空链表、空字符串等。</p>
<h3 id="future">future</h3>
<p>future 可以很方便的起一个新线程来工作，但其运行的线程池是无限制的，如果无节制的使用会导致线上服务 oom，这里推荐一个并发的库 <a href="https://github.com/TheClimateCorporation/claypoole">com.climate/claypoole</a> 可以完美替换 <code>pmap/future/run!</code> 等！</p>
<h2 id="长期维护-clojure-项目">长期维护 Clojure 项目</h2>
<p>Clojure 作为一门动态语言，同样有“编写爽，维护难”痛点，解决方式也是统一的：完备的测试，外加 lint（代码质量检测）。</p>
<h3 id="test">Test</h3>
<p>测试这个问题很尴尬，是每个开发者都知道很重要但很少落实到位的一项技能，除了基本的单元测试，还要有覆盖整条链路的黑盒测试，不仅仅测正常的输入，更多的是异常情况。
下面说下 Clojure 单元测试开发中会用到的一些技巧：</p>
<ol>
<li><a href="https://clojure.github.io/clojure/clojure.test-api.html">clojure.test</a> 提供了最基本的断言，<a href="https://clojuredocs.org/clojure.test/use-fixtures">use-fixtures</a> 可以进行一些 setup 与 teardown</li>
<li><a href="https://clojuredocs.org/clojure.core/with-redefs">with-redefs</a> 可以去 mock 一些外部依赖的返回</li>
<li><a href="https://github.com/venantius/ultra/wiki/Tests">ultra</a> 更直观的测试结果展示</li>
</ol>
<h3 id="lint">Lint</h3>
<p>Clojure 作为一 Lisp 方言，有非常强的表现力，几行代码就可以干很多事情，为了保证整个团队有统一的编程风格，应该在项目起始阶段，就加上质量检测。
Clojure 社区里面，<a href="https://github.com/jonase/eastwood">eastwood</a> 是一个非常全面的 lint 工具，它帮助我发现了很多程序中肉眼难以识别的错误，成熟 Clojure 程序员必备。</p>
<h3 id="跟进社区">跟进社区</h3>
<ul>
<li>Clojure 1.9 引入 <a href="https://clojure.org/news/2017/12/08/clojure19">spec</a>，尝试来解决一直被初学者诟病的错误信息看不懂的问题</li>
<li>Clojure 1.10 更进一步，<a href="https://clojure.org/news/2018/12/17/clojure110">对错误信息进行了分类</a>，适配 Java 9 带来的 module</li>
</ul>
<p>除了 Clojure 语言本身外，Lein/JVM 等周边生态链也在不断推进，我们需要及时去了解这些新技术，现在我比较头疼的是下面这两个：</p>
<ol>
<li>Lein 在 3.0 大版本中会<a href="https://github.com/technomancy/leiningen/blob/master/doc/PLUGINS.md#hooks">移除对 hook 的支持</a>，这将会导致很多有用的插件不可用，包括上面推荐的 lein-shorthand</li>
<li>Java 9 为了支持 module，<a href="https://stackoverflow.com/questions/46494112/classloaders-hierarchy-in-java-9">改变了 classloader 的行为</a>，导致<a href="https://github.com/clojure-emacs/clj-refactor.el/issues/410">无法使用 alembic 提供的动态加载依赖</a>的功能，所以目前只能锁定在 Java 8 上</li>
</ol>
<h2 id="他山之石">他山之石</h2>
<p>Clojure 社区虽小，但不乏高手，通过阅读高手的代码，是熟悉一门语言 idioms 最有效的方式。下面介绍社区内，对我影响最大的三位：</p>
<h3 id="nathan-marzhttpnathanmarzcom"><a href="http://nathanmarz.com/">Nathan Marz</a></h3>
<p>一个非常务实的 coder，文章见解独特、观点新颖。明星项目：</p>
<ul>
<li><a href="https://github.com/nathanmarz/storm">Storm</a> 流式数据框架</li>
<li><a href="https://github.com/nathanmarz/specter">Specter</a> 号称 Clojure(Script)&rsquo;s missing piece，操作复杂数据结构的利器！</li>
<li><a href="https://www.manning.com/books/big-data">Big Data: Principles and best practices of scalable realtime data systems</a>，在本书中提出有名的 <a href="https://en.wikipedia.org/wiki/Lambda_architecture">Lambda 架构</a></li>
<li><a href="https://github.com/nathanmarz/cascalog">Cascalog</a> 这是我 2014 年首次接触 Clojure 时用的项目，主要是分析日志。语法借鉴自声明式逻辑语言 <a href="https://en.wikipedia.org/wiki/Datalog">Datalog</a></li>
</ul>
<h3 id="kyle-kingsburyhttpsaphyrcom-aka-aphyr"><a href="https://aphyr.com">Kyle Kingsbury</a> a.k.a &ldquo;Aphyr&rdquo;</h3>
<p>神人一个，高产 coder。明星项目：</p>
<ul>
<li><a href="http://riemann.io/">Riemann</a> 一个强大的监控系统，具备丰富的<a href="http://riemann.io/api/riemann.streams.html">数据流操作</a></li>
<li><a href="https://jepsen.io/">Jepsen</a> 著名的分布式系统测试框架</li>
<li><a href="https://aphyr.com/tags/Clojure-from-the-ground-up">Clojure from the Ground Up</a> 介绍 Clojure 的一系列文章</li>
<li><a href="https://github.com/aphyr">https://github.com/aphyr</a></li>
</ul>
<h3 id="zach-tellmanhttpsideolaliacom"><a href="https://ideolalia.com/">Zach Tellman</a></h3>
<p>神人另一个，高产 coder，貌似与 Aphyr 共事过</p>
<ul>
<li><a href="https://elementsofclojure.com/">Elements of Clojure</a> This book tries to put words to what most experienced programmers already know</li>
<li><a href="https://github.com/ztellman">https://github.com/ztellman</a>
我目前还没直接使用过 Zach 写的库，这是由于他的库很多都是基本性质的，所以很有极有可能间接引用了他的库，比如 specter 就用了他的 riddley。下面一张图摘自他的博客：

  <figure>
    <img src="https://ideolalia.com/images/libraries.png" alt="Zach&amp;rsquo;s libraries">
    <figcaption><center>Zach&amp;rsquo;s libraries</center></figcaption>
  </figure>

</li>
</ul>
<p>混 Clojure 社区，应该还会经常看到 Congnitect 公司内的 <a href="https://github.com/richhickey">Rich</a>/<a href="https://github.com/stuarthalloway">Stuart Halloway</a>/<a href="https://github.com/puredanger">Alex Miller</a>/<a href="http://blog.fogus.me/">Michael Fogus</a>&hellip;</p>
<h2 id="clojure-工作机会">Clojure 工作机会</h2>
<p>首先明确一点，语言只是工具，而只会工具是找不到工作的，很多初学 Clojure 的同学都有这个误区。打个比方：一个厨师的刀工非常好，但是不知道如何去做菜（领域知识），有什么用呢？</p>
<p>比如，做 Web 开发，那对 HTTP 了解多少？ TCP/UDP 区别是什么？Mysql 锁有几种？这些都是必须的。再进一步，JVM 上的 gc 懂吗？多线程用过没？linux 上如何排除进程相关信息？</p>
<p>有了以上基础，我们也不得不承认，使用 Clojure 作为主力开发语言的公司确实少，但也不是没有，比如：北京的 LeanCloud/BearyChat、深圳的 <a href="https://www.bagevent.com/event/1760284">风林火山</a> 。
即使工作中无法使用，了解这门优雅、富有表现力的语言来扩展自己的眼界，也是不错的选择。</p>
<h2 id="总结">总结</h2>
<p>从 14 年实习期间接触 Clojure，到现在 19 年差不多 5 年了，学到了太多太多东西，一方面是编程语言的设计，另一方面是后端开发的整个体系。坊间甚至一度传闻 <a href="https://news.ycombinator.com/item?id=14418013">Clojure is dead</a>。
Clojure 不是银弹，肯定是有一些瑕疵，但这并不妨碍它是一门优秀的语言，虽然我现在工作中用不到它了，但是业余时间肯定还是会去研究它，社区有太多有意思的项目了。
希望新入门的同学可以坚持下去，早日体味到 Clojure 的乐趣。加油！</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">刘家财</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-12-09
        <a href="https://github.com/jiacai2050/jiacai2050.github.io/commit/7baed381ccd039448ee6c345058e7a3472cf81fc" title="fix bad format">(7baed38)</a>
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/clojure/">Clojure</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/blog/2019/07/17/hello-golang/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">写给新手的 Go 开发指南</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/blog/2019/01/09/java-gc-definitive-guide/">
            <span class="next-text nav-default">Java 垃圾回收权威指北</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'jiacai2050';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:jiacai2050&#43;blog@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/2163429/jiacai-liu" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://www.twitter.com/liujiacai" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/jiacai2050" class="iconfont icon-github" title="github"></a>
      <a href="http://weibo.com/liujiacai" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://www.zhihu.com/people/jiacai2050" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.douban.com/people/liujiacai/" class="iconfont icon-douban" title="douban"></a>
  <a href="https://liujiacai.net/atom.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2014 - 
    2020<span class="heart"><i class="iconfont icon-heart"></i></span><span>刘家财</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-50745138-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?3ffc15f400ce3f8b1db5afc4f29b6ce9";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
